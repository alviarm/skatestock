# Ephemeral Deployment Workflow
# Spins up infrastructure for 4 hours, then auto-destroys
# Cost: ~$0.28 for 4-hour interview session

name: Ephemeral Interview Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "interview"
        type: string
      destroy_after_minutes:
        description: "Auto-destroy after N minutes"
        required: true
        default: "240" # 4 hours
        type: string

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      id-token: write # Required for AWS OIDC

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: infrastructure/terraform
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="enable_auto_destroy=true" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform
        run: terraform apply -auto-approve tfplan

      - name: Get Outputs
        working-directory: infrastructure/terraform
        id: outputs
        run: |
          echo "rds_endpoint=$(terraform output -raw rds_endpoint)" >> $GITHUB_OUTPUT
          echo "redis_endpoint=$(terraform output -raw redis_endpoint)" >> $GITHUB_OUTPUT
          echo "ecs_cluster=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT

      - name: Comment Deployment Info
        uses: actions/github-script@v7
        with:
          script: |
            const outputs = {
              rds: '${{ steps.outputs.outputs.rds_endpoint }}',
              redis: '${{ steps.outputs.outputs.redis_endpoint }}',
              ecs: '${{ steps.outputs.outputs.ecs_cluster }}'
            };

            const body = `## ðŸš€ Ephemeral Deployment Started

            **Environment:** ${{ github.event.inputs.environment }}
            **Auto-destroy:** ${{ github.event.inputs.destroy_after_minutes }} minutes

            ### Infrastructure Details
            - **ECS Cluster:** ${outputs.ecs}
            - **RDS Endpoint:** ${outputs.rds}
            - **Redis Endpoint:** ${outputs.redis}

            ### Cost Estimate
            - **Hourly:** ~$0.07/hour
            - **Session:** ~$${(0.07 * ${{ github.event.inputs.destroy_after_minutes }} / 60).toFixed(2)}

            ### Important
            âš ï¸ This infrastructure will be **automatically destroyed** in ${{ github.event.inputs.destroy_after_minutes }} minutes.

            To destroy manually: Run the "Destroy Infrastructure" workflow.

            ---
            â° Started at: ${new Date().toISOString()}
            ðŸ”¥ Destroys at: ${new Date(Date.now() + ${{ github.event.inputs.destroy_after_minutes }} * 60000).toISOString()}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  schedule-destroy:
    name: Schedule Auto-Destroy
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Schedule Destroy Job
        run: |
          echo "Scheduling destroy in ${{ github.event.inputs.destroy_after_minutes }} minutes"
          echo "DESTROY_TIME=$(date -d '+${{ github.event.inputs.destroy_after_minutes }} minutes' -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: Trigger Destroy Workflow
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'destroy-infrastructure.yml',
              ref: context.ref,
              inputs: {
                environment: '${{ github.event.inputs.environment }}',
                scheduled: 'true'
              }
            });

  notify:
    name: Send Notification
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack/Discord (Optional)
        if: secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸš€ SkateStack ephemeral deployment started. Auto-destroy in ${{ github.event.inputs.destroy_after_minutes }} minutes."}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true
